<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leader Dashboard - WizDesk</title>
    <link rel="stylesheet" href="leader.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>WizDesk</h1>
                <p>Leader Dashboard</p>
            </div>
            <ul class="nav-links">
                <li class="active" data-tab="overview">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </li>
                <li data-tab="approval-requests">
                    <span class="nav-icon">üë•</span>
                    <span>Approve Members</span>
                    <span id="pendingRequestsBadge" class="status-badge status-pending" style="margin-left: auto; display: none;">0</span>
                </li>
                <li data-tab="tasks">
                    <span class="nav-icon">üìù</span>
                    <span>Task Management</span>
                </li>
                <li data-tab="active-tasks">
                    <span class="nav-icon">‚ö°</span>
                    <span>Active Tasks</span>
                </li>
                <li data-tab="completed-tasks">
                    <span class="nav-icon">‚úÖ</span>
                    <span>Completed Tasks</span>
                </li>
                <li data-tab="members">
                    <span class="nav-icon">üë•</span>
                    <span>Team Members</span>
                </li>
                <li data-tab="rejected-members">
                    <span class="nav-icon">‚ùå</span>
                    <span>Rejected Members</span>
                </li>
                <li data-tab="performance">
                    <span class="nav-icon">üìà</span>
                    <span>Performance</span>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <h1>Team Management</h1>
                    <p>Monitor and manage your team's progress</p>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-role">Team Leader</span>
                    </div>
                    <span class="team-code" id="teamCodeDisplay"></span>
                    <button id="logoutBtn" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="action-card" onclick="showCreateTaskModal()">
                            <div class="action-icon">‚ûï</div>
                            <div class="action-title">Create Task</div>
                            <div class="action-desc">Create new task with subtasks</div>
                        </div>
                        <div class="action-card" onclick="showTab('approval-requests')">
                            <div class="action-icon">üë•</div>
                            <div class="action-title">Approve Members</div>
                            <div class="action-desc">Review pending member requests</div>
                        </div>
                        <div class="action-card" onclick="showTab('members')">
                            <div class="action-icon">üë•</div>
                            <div class="action-title">Manage Team</div>
                            <div class="action-desc">View and manage team members</div>
                        </div>
                        <div class="action-card" onclick="showTab('performance')">
                            <div class="action-icon">üìà</div>
                            <div class="action-title">View Reports</div>
                            <div class="action-desc">Check team performance</div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                        <div class="stat-card completed">
                            <div class="stat-number" id="completedTasks">0</div>
                            <div class="stat-label">Completed Tasks</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-number" id="activeTasks">0</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card members">
                            <div class="stat-number" id="teamMembers">0</div>
                            <div class="stat-label">Team Members</div>
                        </div>
                        <div class="stat-card requests">
                            <div class="stat-number" id="pendingRequests">0</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                    </div>

                    <!-- Recent Tasks -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Recent Tasks</h2>
                            <button class="btn btn-primary" onclick="showCreateTaskModal()">Create New Task</button>
                        </div>
                        <div id="recentTasksList" class="task-list">
                            <div class="empty-state">
                                <div class="icon">üìù</div>
                                <h3>No Tasks Yet</h3>
                                <p>Create your first task to get started</p>
                                <button class="btn btn-primary" onclick="showCreateTaskModal()" style="margin-top: 15px;">
                                    Create First Task
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Approval Requests Tab -->
                <div id="approval-requests" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Member Approval Requests</h2>
                        </div>
                        <div id="approvalRequestsList">
                            <!-- Pending approval requests will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Task Management Tab -->
                <div id="tasks" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Task Management</h2>
                            <button class="btn btn-primary" onclick="showCreateTaskModal()">Create New Task</button>
                        </div>
                        
                        <div class="task-filter">
                            <button class="filter-btn active" onclick="showTab('tasks')">All Tasks</button>
                            <button class="filter-btn" onclick="showTab('active-tasks')">Active Tasks</button>
                            <button class="filter-btn" onclick="showTab('completed-tasks')">Completed Tasks</button>
                        </div>
                        
                        <div class="task-list" id="allTasksManagement">
                            <!-- All tasks with management options will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Active Tasks Tab -->
                <div id="active-tasks" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Active Tasks</h2>
                        </div>
                        <div class="task-list" id="activeTasksList">
                            <!-- Active tasks will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Completed Tasks Tab -->
                <div id="completed-tasks" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Completed Tasks</h2>
                        </div>
                        <div class="task-list" id="completedTasksList">
                            <!-- Completed tasks will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div id="members" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Team Members</h2>
                        </div>
                        <div class="members-list" id="membersList">
                            <!-- All team members will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Rejected Members Tab -->
                <div id="rejected-members" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Rejected Members</h2>
                        </div>
                        <div class="members-list" id="rejectedMembersList">
                            <!-- Rejected members will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div id="performance" class="tab-content" style="display: none;">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Performance Analytics</h2>
                        </div>
                        
                        <!-- Top Performers Section -->
                        <div class="top-performers-section" style="margin-bottom: 30px;">
                            <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2rem;">üèÜ Top Performers</h3>
                            <div class="top-performers-grid" id="topPerformersGrid">
                                <!-- Top performers will be loaded here -->
                            </div>
                        </div>

                        <div class="performance-controls">
                            <div class="search-box">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="performanceSearch" class="search-input" placeholder="Search by name or email...">
                            </div>
                            
                            <div class="performance-filters">
                                <button class="performance-filter-btn active" data-filter="all">All Members</button>
                                <button class="performance-filter-btn" data-filter="top">Top Performers</button>
                                <button class="performance-filter-btn" data-filter="low">Low Performers</button>
                            </div>
                        </div>
                        
                        <div class="performance-stats" id="performanceStats" style="display: none;">
                            <!-- Performance stats will be loaded here -->
                        </div>
                        
                        <!-- All Team Members Performance -->
                        <div class="all-members-section">
                            <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2rem;">üë• All Team Members</h3>
                            <div class="members-performance-table" id="membersPerformanceTable">
                                <!-- Members performance table will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Task</h2>
                <span class="close" onclick="closeModal('createTaskModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="form-group">
                        <label class="form-label">Task Title *</label>
                        <input type="text" class="form-input" id="taskTitle" placeholder="Enter a clear task title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <textarea class="form-textarea" id="taskDescription" placeholder="Describe the task in detail... (Optional)"></textarea>
                    </div>

                    <!-- Assignment Section -->
                    <div class="assignment-section">
                        <div class="assignment-toggle" onclick="toggleAssignment()">
                            <div class="toggle-switch" id="assignmentToggle"></div>
                            <div class="toggle-label">Assign specific team members to subtasks</div>
                        </div>

                        <div id="assignmentSection" style="display: none;">
                            <div class="member-search">
                                <input type="text" class="search-input" id="memberSearch" placeholder="Search team members..." onkeyup="filterMembers()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Available Team Members</label>
                                <div style="background: white; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto;">
                                    <div id="membersChecklist">
                                        <!-- Members will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Selected Members for Assignment</label>
                                <div id="selectedMembersList" class="selected-members-list">
                                    <!-- Selected members will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subtasks Section - UPDATED with description field -->
                    <div class="subtasks-section">
                        <div class="form-group">
                            <label class="form-label">Subtasks *</label>
                            <div id="subtasksContainer">
                                <div class="subtask-item">
                                    <input type="text" class="subtask-input" placeholder="Subtask title (e.g., Design homepage)" required>
                                    <textarea class="subtask-desc" placeholder="Subtask description (Optional)"></textarea>
                                    <select class="form-select assignee-select" style="display: none;">
                                        <option value="">Select member...</option>
                                    </select>
                                    <button type="button" class="remove-subtask" onclick="removeSubtask(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline" onclick="addSubtaskField()" style="margin-top: 10px;">
                                + Add Another Subtask
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('createTaskModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 2;">
                            Create Task & Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Task</h2>
                <span class="close" onclick="closeModal('editTaskModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editTaskForm" onsubmit="updateTask(); return false;">
                    <input type="hidden" id="editTaskId">
                    <div class="form-group">
                        <label class="form-label">Task Title *</label>
                        <input type="text" class="form-input" id="editTaskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <textarea class="form-textarea" id="editTaskDescription"></textarea>
                    </div>

                    <div class="subtasks-section">
                        <div class="form-group">
                            <label class="form-label">Subtasks *</label>
                            <div id="editSubtasksContainer">
                                <!-- Subtasks will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('editTaskModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deleteTaskFromEdit()" style="flex: 1;">
                            Delete Task
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 2;">
                            Update Task
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="modal task-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Task Details</h2>
                <span class="close" onclick="closeModal('taskDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="task-detail-header">
                    <div>
                        <div class="task-detail-title" id="detailTaskTitle">Task Title</div>
                        <div class="task-detail-description" id="detailTaskDescription">Task description goes here...</div>
                    </div>
                    <span class="status-badge" id="detailTaskStatus">Status</span>
                </div>
                
                <div class="task-detail-meta">
                    <div class="meta-item">
                        <div class="meta-label">Created By</div>
                        <div class="meta-value" id="detailCreatedBy">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Created On</div>
                        <div class="meta-value" id="detailCreatedAt">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Completed On</div>
                        <div class="meta-value" id="detailCompletedAt">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Progress</div>
                        <div class="meta-value" id="detailProgress">-</div>
                    </div>
                </div>
                
                <div class="detail-subtasks-section">
                    <h3 style="margin-bottom: 15px;">Subtasks</h3>
                    <div class="detail-subtask-list" id="detailSubtasksList">
                        <!-- Subtasks will be populated here -->
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('taskDetailModal')" style="flex: 1;">
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="detailEditBtn" style="flex: 1;">
                        Edit Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Performance Details Modal -->
    <div id="memberPerformanceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Member Performance Details</h2>
                <span class="close" onclick="closeModal('memberPerformanceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="memberPerformanceContent">
                    <!-- Member performance details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let teamMembers = [];
        let allTasks = [];
        let pendingRequests = [];
        let rejectedMembers = [];
        let memberPerformanceData = [];
        let selectedMembers = [];

        // üîê AUTHENTICATION CHECK
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userData);
            
            // For leader dashboard - check if user is actually a leader
            if (window.location.pathname.includes('leader-dashboard.html') && currentUser.role !== 'leader') {
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                return;
            }
            
            // Initialize dashboard after authentication passes
            initializeDashboard();
            loadTeamData();
        });

        // Utility functions
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 4000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Load specific data for tabs
            switch(tabId) {
                case 'approval-requests':
                    loadApprovalRequests();
                    break;
                case 'tasks':
                    loadAllTasksForManagement();
                    break;
                case 'members':
                    loadAllTeamMembers();
                    break;
                case 'rejected-members':
                    loadRejectedMembers();
                    break;
                case 'active-tasks':
                    loadTasksByStatus('active');
                    break;
                case 'completed-tasks':
                    loadTasksByStatus('completed');
                    break;
                case 'performance':
                    loadPerformanceData();
                    break;
            }
        }

        function initializeDashboard() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('teamCodeDisplay').textContent = currentUser.team_code;

            // Navigation
            document.querySelectorAll('.nav-links li').forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            });

            // Performance search functionality
            document.getElementById('performanceSearch').addEventListener('input', function() {
                filterPerformanceData();
            });

            // Performance filter functionality
            document.querySelectorAll('.performance-filters .performance-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.performance-filters .performance-filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    filterPerformanceData();
                });
            });
        }

        async function loadTeamData() {
            try {
                // Load team members (only approved)
                const membersResponse = await fetch(`${API_BASE}/auth/team/${currentUser.team_code}/all-members`);
                if (membersResponse.ok) {
                    teamMembers = await membersResponse.json();
                } else {
                    console.error('Failed to load team members');
                    teamMembers = [];
                }
                
                // Load pending requests
                await loadPendingRequests();
                
                // Load rejected members
                await loadRejectedMembers();
                
                // Load tasks
                await loadTasks();
                
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading team data:', error);
                showMessage('Failed to load team data', 'error');
            }
        }

        async function loadPendingRequests() {
            try {
                const response = await fetch(`${API_BASE}/auth/team/${currentUser.team_code}/pending-requests`);
                if (response.ok) {
                    pendingRequests = await response.json();
                    updatePendingRequestsBadge();
                } else {
                    console.error('Failed to load pending requests');
                    pendingRequests = [];
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
                pendingRequests = [];
            }
        }

        async function loadRejectedMembers() {
            try {
                const response = await fetch(`${API_BASE}/auth/team/${currentUser.team_code}/rejected-members`);
                if (response.ok) {
                    rejectedMembers = await response.json();
                    updateRejectedMembersDisplay();
                } else {
                    console.error('Failed to load rejected members');
                    rejectedMembers = [];
                    updateRejectedMembersDisplay();
                }
            } catch (error) {
                console.error('Error loading rejected members:', error);
                rejectedMembers = [];
                updateRejectedMembersDisplay();
            }
        }

        function updatePendingRequestsBadge() {
            const badge = document.getElementById('pendingRequestsBadge');
            const stat = document.getElementById('pendingRequests');
            
            if (pendingRequests.length > 0) {
                badge.textContent = pendingRequests.length;
                badge.style.display = 'block';
                stat.textContent = pendingRequests.length;
            } else {
                badge.style.display = 'none';
                stat.textContent = '0';
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/tasks/team/${currentUser.team_code}`);
                if (response.ok) {
                    allTasks = await response.json();
                    displayRecentTasks();
                } else {
                    console.error('Failed to load tasks');
                    allTasks = [];
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                showMessage('Failed to load tasks', 'error');
                allTasks = [];
            }
        }

        function displayRecentTasks() {
            const container = document.getElementById('recentTasksList');
            
            if (allTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <h3>No Tasks Yet</h3>
                        <p>Create your first task to get started</p>
                        <button class="btn btn-primary" onclick="showCreateTaskModal()" style="margin-top: 15px;">
                            Create First Task
                        </button>
                    </div>
                `;
                return;
            }

            const recentTasks = allTasks.slice(0, 5);
            container.innerHTML = recentTasks.map(task => `
                <div class="task-card" onclick="showTaskDetail(${task.id})" style="cursor: pointer;">
                    <div class="task-header">
                        <div>
                            <div class="task-title">${task.title}</div>
                            <div class="task-description">${task.description || 'No description provided'}</div>
                        </div>
                        <span class="status-badge ${getTaskStatusClass(task)}">${getTaskStatusText(task)}</span>
                    </div>
                    <div class="progress-section">
                        <div class="progress-info">
                            <span>Progress</span>
                            <span>${calculateProgress(task)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${calculateProgress(task)}%"></div>
                        </div>
                    </div>
                    <div class="task-meta">
                        <div>
                            <span style="color: #666; font-size: 0.9rem;">
                                ${task.subtasks.length} subtasks ‚Ä¢ Created by ${task.created_by_name}
                            </span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editTask(${task.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask(${task.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function calculateProgress(task) {
            if (task.subtasks.length === 0) return 0;
            const completed = task.subtasks.filter(st => st.status === 'completed').length;
            return Math.round((completed / task.subtasks.length) * 100);
        }

        function updateDashboardStats() {
            document.getElementById('totalTasks').textContent = allTasks.length;
            
            const activeTasks = allTasks.filter(task => 
                task.subtasks.some(subtask => subtask.status !== 'completed')
            ).length;
            document.getElementById('activeTasks').textContent = activeTasks;
            
            document.getElementById('teamMembers').textContent = teamMembers.length;
            
            const completedTasks = allTasks.filter(task => 
                task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed')
            ).length;
            document.getElementById('completedTasks').textContent = completedTasks;
        }

        // üÜï LIVE TASK DELETION FUNCTIONS
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task? This will also delete all subtasks.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Task deleted successfully!', 'success');
                    // Remove task from local array immediately
                    allTasks = allTasks.filter(task => task.id !== taskId);
                    // Update all displays immediately
                    updateTaskDisplays();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showMessage('Failed to delete task', 'error');
            }
        }

        async function deleteTaskFromEdit() {
            const taskId = document.getElementById('editTaskId').value;
            
            if (!confirm('Are you sure you want to delete this task? This will also delete all subtasks.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Task deleted successfully!', 'success');
                    closeModal('editTaskModal');
                    // Remove task from local array immediately
                    allTasks = allTasks.filter(task => task.id !== taskId);
                    // Update all displays immediately
                    updateTaskDisplays();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showMessage('Failed to delete task', 'error');
            }
        }

        function updateTaskDisplays() {
            // Update dashboard stats
            updateDashboardStats();
            
            // Update recent tasks
            displayRecentTasks();
            
            // Update task management view if it's currently active
            const tasksTab = document.getElementById('tasks');
            if (tasksTab.style.display !== 'none') {
                displayTasksForManagement(allTasks);
            }
            
            // Update active tasks view if it's currently active
            const activeTasksTab = document.getElementById('active-tasks');
            if (activeTasksTab.style.display !== 'none') {
                const activeTasks = allTasks.filter(task => 
                    task.subtasks.some(subtask => subtask.status !== 'completed')
                );
                displayFilteredTasks(document.getElementById('activeTasksList'), activeTasks, 'active');
            }
            
            // Update completed tasks view if it's currently active
            const completedTasksTab = document.getElementById('completed-tasks');
            if (completedTasksTab.style.display !== 'none') {
                const completedTasks = allTasks.filter(task => 
                    task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed')
                );
                displayFilteredTasks(document.getElementById('completedTasksList'), completedTasks, 'completed');
            }
        }

        // Approval Requests Functions
        async function loadApprovalRequests() {
            const container = document.getElementById('approvalRequestsList');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <h3>No Pending Requests</h3>
                        <p>All member requests have been processed</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingRequests.map(request => `
                <div class="request-card" id="request-${request.id}">
                    <div class="request-header">
                        <div class="request-info">
                            <div class="request-name">${request.name}</div>
                            <div class="request-email">${request.email}</div>
                            <div class="request-meta">
                                Requested to join on ${new Date(request.created_at).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn btn-success btn-sm" onclick="approveMember(${request.id})">
                                Approve
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectMember(${request.id})">
                                Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function approveMember(userId) {
            try {
                const response = await fetch(`${API_BASE}/auth/approve-member`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        teamCode: currentUser.team_code,
                        approvedBy: currentUser.id
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Member approved successfully!', 'success');
                    
                    // Remove from pending requests immediately
                    const requestIndex = pendingRequests.findIndex(req => req.id === userId);
                    if (requestIndex > -1) {
                        pendingRequests.splice(requestIndex, 1);
                    }
                    
                    // Update UI immediately
                    document.getElementById(`request-${userId}`)?.remove();
                    updatePendingRequestsBadge();
                    
                    // Reload team members to show the newly approved member
                    await loadAllTeamMembers();
                    updateDashboardStats();
                    
                    // If no more requests, show empty state
                    if (pendingRequests.length === 0) {
                        document.getElementById('approvalRequestsList').innerHTML = `
                            <div class="empty-state">
                                <div class="icon">‚úÖ</div>
                                <h3>No Pending Requests</h3>
                                <p>All member requests have been processed</p>
                            </div>
                        `;
                    }
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error approving member:', error);
                showMessage('Failed to approve member', 'error');
            }
        }

        async function rejectMember(userId) {
            try {
                const response = await fetch(`${API_BASE}/auth/reject-member`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        teamCode: currentUser.team_code,
                        rejectedBy: currentUser.id
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Member request rejected', 'success');
                    
                    // Remove from pending requests immediately
                    const requestIndex = pendingRequests.findIndex(req => req.id === userId);
                    if (requestIndex > -1) {
                        pendingRequests.splice(requestIndex, 1);
                    }
                    
                    // Update UI immediately
                    document.getElementById(`request-${userId}`)?.remove();
                    updatePendingRequestsBadge();
                    
                    // Add to rejected members and update rejected tab
                    rejectedMembers.unshift(result.user);
                    updateRejectedMembersDisplay();
                    
                    // If no more requests, show empty state
                    if (pendingRequests.length === 0) {
                        document.getElementById('approvalRequestsList').innerHTML = `
                            <div class="empty-state">
                                <div class="icon">‚úÖ</div>
                                <h3>No Pending Requests</h3>
                                <p>All member requests have been processed</p>
                            </div>
                        `;
                    }
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error rejecting member:', error);
                showMessage('Failed to reject member', 'error');
            }
        }

        function updateRejectedMembersDisplay() {
            const container = document.getElementById('rejectedMembersList');
            
            if (rejectedMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <h3>No Rejected Members</h3>
                        <p>No member requests have been rejected yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rejectedMembers.map(member => `
                <div class="member-card" id="rejected-member-${member.id}">
                    <div class="member-avatar">
                        ${member.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="member-name">${member.name}</div>
                    <div class="member-email">${member.email}</div>
                    <div class="status-badge status-rejected">REJECTED</div>
                    <div class="request-meta" style="margin: 10px 0; color: #888;">
                        Rejected on ${new Date(member.updated_at || member.created_at).toLocaleDateString()}
                    </div>
                    <div class="member-actions">
                        <button class="btn btn-info btn-sm" onclick="approveRejectedMember(${member.id})">
                            Approve Again
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRejectedMember(${member.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveRejectedMember(userId) {
            try {
                const response = await fetch(`${API_BASE}/auth/approve-rejected-member`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        teamCode: currentUser.team_code,
                        approvedBy: currentUser.id
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Member approved successfully!', 'success');
                    
                    // Remove from rejected members immediately
                    const rejectedIndex = rejectedMembers.findIndex(member => member.id === userId);
                    if (rejectedIndex > -1) {
                        rejectedMembers.splice(rejectedIndex, 1);
                    }
                    
                    // Update UI immediately
                    document.getElementById(`rejected-member-${userId}`)?.remove();
                    
                    // Reload team members to show the newly approved member
                    await loadAllTeamMembers();
                    updateDashboardStats();
                    
                    // Update rejected members display
                    updateRejectedMembersDisplay();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error approving rejected member:', error);
                showMessage('Failed to approve member', 'error');
            }
        }

        async function deleteRejectedMember(userId) {
            if (!confirm('Are you sure you want to permanently delete this rejected member record?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/delete-rejected-member/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Rejected member record deleted permanently', 'success');
                    
                    // Remove from rejected members immediately
                    const rejectedIndex = rejectedMembers.findIndex(member => member.id === userId);
                    if (rejectedIndex > -1) {
                        rejectedMembers.splice(rejectedIndex, 1);
                    }
                    
                    // Update UI immediately
                    document.getElementById(`rejected-member-${userId}`)?.remove();
                    
                    // Update rejected members display
                    updateRejectedMembersDisplay();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting rejected member:', error);
                showMessage('Failed to delete rejected member', 'error');
            }
        }

        // Task Management Functions
        async function loadAllTasksForManagement() {
            try {
                const response = await fetch(`${API_BASE}/tasks/team/${currentUser.team_code}`);
                if (response.ok) {
                    const tasks = await response.json();
                    displayTasksForManagement(tasks);
                } else {
                    console.error('Failed to load tasks for management');
                    displayTasksForManagement([]);
                }
            } catch (error) {
                console.error('Error loading tasks for management:', error);
                showMessage('Failed to load tasks', 'error');
                displayTasksForManagement([]);
            }
        }

        function displayTasksForManagement(tasks) {
            const container = document.getElementById('allTasksManagement');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <h3>No Tasks Created</h3>
                        <p>Create your first task to get started</p>
                        <button class="btn btn-primary" onclick="showCreateTaskModal()">
                            Create First Task
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-card" onclick="showTaskDetail(${task.id})" style="cursor: pointer;">
                    <div class="task-header">
                        <div>
                            <div class="task-title">${task.title}</div>
                            <div class="task-description">${task.description || 'No description'}</div>
                        </div>
                        <span class="status-badge ${getTaskStatusClass(task)}">${getTaskStatusText(task)}</span>
                    </div>
                    
                    <div class="progress-section">
                        <div class="progress-info">
                            <span>Progress</span>
                            <span>${calculateProgress(task)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${calculateProgress(task)}%"></div>
                        </div>
                    </div>

                    <div class="task-meta">
                        <div>
                            <span style="color: #666; font-size: 0.9rem;">
                                ${task.subtasks.length} subtasks ‚Ä¢ Created by ${task.created_by_name}
                            </span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editTask(${task.id})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTask(${task.id})">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Edit Task Functionality
        async function editTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch task');
                }
                const task = await response.json();
                
                // Populate edit form
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || '';
                
                // Populate subtasks for editing
                const subtasksContainer = document.getElementById('editSubtasksContainer');
                subtasksContainer.innerHTML = task.subtasks.map(subtask => `
                    <div class="edit-subtask-item" data-subtask-id="${subtask.id}">
                        <input type="text" class="edit-subtask-input" value="${subtask.title}" placeholder="Subtask title" required>
                        <textarea class="edit-subtask-desc" placeholder="Subtask description">${subtask.description || ''}</textarea>
                        <select class="form-select assignee-select">
                            <option value="">Not assigned</option>
                            ${teamMembers.map(member => 
                                `<option value="${member.id}" ${subtask.assigned_to === member.id ? 'selected' : ''}>
                                    ${member.name} - ${member.email}
                                </option>`
                            ).join('')}
                        </select>
                        <button type="button" class="remove-subtask" onclick="removeEditSubtask(this)">Remove</button>
                    </div>
                `).join('');
                
                showModal('editTaskModal');
            } catch (error) {
                console.error('Error loading task for editing:', error);
                showMessage('Failed to load task details', 'error');
            }
        }

        async function updateTask() {
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value;
            const description = document.getElementById('editTaskDescription').value;
            
            // Collect subtask updates
            const subtaskItems = document.querySelectorAll('#editSubtasksContainer .edit-subtask-item');
            const subtaskUpdates = Array.from(subtaskItems).map(item => {
                const subtaskId = item.getAttribute('data-subtask-id');
                const title = item.querySelector('.edit-subtask-input').value;
                const description = item.querySelector('.edit-subtask-desc').value;
                const assignedTo = item.querySelector('.assignee-select').value;
                
                return {
                    id: subtaskId,
                    title,
                    description,
                    assigned_to: assignedTo || null
                };
            });

            try {
                // Update main task
                const taskResponse = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        userId: currentUser.id
                    })
                });

                if (!taskResponse.ok) {
                    const error = await taskResponse.json();
                    throw new Error(error.error || 'Failed to update task');
                }

                // Update subtasks
                for (const subtask of subtaskUpdates) {
                    const subtaskResponse = await fetch(`${API_BASE}/tasks/subtask/${subtask.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: subtask.title,
                            description: subtask.description,
                            assigned_to: subtask.assigned_to,
                            userId: currentUser.id
                        })
                    });

                    if (!subtaskResponse.ok) {
                        const error = await subtaskResponse.json();
                        throw new Error(error.error || 'Failed to update subtask');
                    }
                }

                showMessage('Task updated successfully!', 'success');
                closeModal('editTaskModal');
                // Update tasks immediately
                allTasks = allTasks.map(task => task.id === parseInt(taskId) ? { ...task, title, description } : task);
                updateTaskDisplays();
            } catch (error) {
                console.error('Error updating task:', error);
                showMessage(error.message || 'Failed to update task', 'error');
            }
        }

        function removeEditSubtask(button) {
            if (document.querySelectorAll('.edit-subtask-item').length > 1) {
                button.parentElement.remove();
            } else {
                showMessage('At least one subtask is required', 'error');
            }
        }

        // Task Filtering Functions
        async function loadTasksByStatus(status) {
            try {
                const response = await fetch(`${API_BASE}/tasks/team/${currentUser.team_code}/status/${status}`);
                if (response.ok) {
                    const tasks = await response.json();
                    
                    if (status === 'active') {
                        displayActiveTasks(tasks);
                    } else if (status === 'completed') {
                        displayCompletedTasks(tasks);
                    }
                } else {
                    console.error('Failed to load tasks by status');
                    if (status === 'active') {
                        displayActiveTasks([]);
                    } else if (status === 'completed') {
                        displayCompletedTasks([]);
                    }
                }
            } catch (error) {
                console.error('Error loading tasks by status:', error);
                showMessage('Failed to load tasks', 'error');
                if (status === 'active') {
                    displayActiveTasks([]);
                } else if (status === 'completed') {
                    displayCompletedTasks([]);
                }
            }
        }

        function displayActiveTasks(tasks) {
            const container = document.getElementById('activeTasksList');
            const activeTasks = tasks.filter(task => 
                task.subtasks.some(subtask => subtask.status !== 'completed')
            );
            
            displayFilteredTasks(container, activeTasks, 'active');
        }

        function displayCompletedTasks(tasks) {
            const container = document.getElementById('completedTasksList');
            const completedTasks = tasks.filter(task => 
                task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed')
            );
            
            displayFilteredTasks(container, completedTasks, 'completed');
        }

        function displayFilteredTasks(container, tasks, type) {
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">${type === 'active' ? 'üìù' : '‚úÖ'}</div>
                        <h3>No ${type} Tasks</h3>
                        <p>${type === 'active' ? 'All tasks are completed!' : 'Complete some tasks to see them here.'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => {
                const isCompleted = task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed');
                const statusText = isCompleted ? 'Completed' : 'In Progress';
                const statusClass = isCompleted ? 'status-completed' : 'status-in-progress';

                return `
                    <div class="task-card" onclick="showTaskDetail(${task.id})" style="cursor: pointer;">
                        <div class="task-header">
                            <div>
                                <div class="task-title">${task.title}</div>
                                <div class="task-description">${task.description || 'No description'}</div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="progress-section">
                            <div class="progress-info">
                                <span>Progress</span>
                                <span>${calculateProgress(task)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${calculateProgress(task)}%"></div>
                            </div>
                        </div>

                        <div class="task-meta">
                            <div>
                                <span style="color: #666; font-size: 0.9rem;">
                                    ${task.subtasks.length} subtasks ‚Ä¢ Created by ${task.created_by_name}
                                </span>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editTask(${task.id})">
                                    Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper functions for task status
        function getTaskStatusClass(task) {
            const isCompleted = task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed');
            const hasAssigned = task.subtasks.some(st => st.status === 'assigned' || st.status === 'taken');
            
            if (isCompleted) return 'status-completed';
            if (hasAssigned) return 'status-in-progress';
            return 'status-available';
        }

        function getTaskStatusText(task) {
            const isCompleted = task.subtasks.length > 0 && task.subtasks.every(st => st.status === 'completed');
            const hasAssigned = task.subtasks.some(st => st.status === 'assigned' || st.status === 'taken');
            
            if (isCompleted) return 'Completed';
            if (hasAssigned) return 'In Progress';
            return 'Available';
        }

        // Member Management Functions
        async function loadAllTeamMembers() {
            try {
                const response = await fetch(`${API_BASE}/auth/team/${currentUser.team_code}/all-members`);
                if (response.ok) {
                    const members = await response.json();
                    teamMembers = members;
                    displayAllTeamMembers(members);
                } else {
                    console.error('Failed to load team members');
                    teamMembers = [];
                    displayAllTeamMembers([]);
                }
            } catch (error) {
                console.error('Error loading team members:', error);
                showMessage('Failed to load team members', 'error');
                teamMembers = [];
                displayAllTeamMembers([]);
            }
        }

        function displayAllTeamMembers(members) {
            const container = document.getElementById('membersList');
            
            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>No Team Members</h3>
                        <p>Team members will appear here when they join</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = members.map(member => `
                <div class="member-card">
                    <div class="member-avatar">
                        ${member.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="member-name">${member.name}</div>
                    <div class="member-email">${member.email}</div>
                    <div class="member-role ${member.role}">${member.role.toUpperCase()}</div>
                    <div class="member-stats">
                        <div class="stat">
                            <div class="stat-value">${member.assigned_tasks || 0}</div>
                            <div class="stat-label">Tasks</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${member.completed_tasks || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                    ${member.role === 'member' ? `
                        <div class="member-actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id}, '${member.name}')">
                                Remove
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function deleteMember(memberId, memberName) {
            if (!confirm(`Are you sure you want to remove ${memberName} from the team?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/team/${currentUser.team_code}/member/${memberId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leaderId: currentUser.id })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Member removed successfully!', 'success');
                    loadAllTeamMembers(); // Refresh members list
                    updateDashboardStats();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting member:', error);
                showMessage('Failed to remove member', 'error');
            }
        }

        // Task Creation Functions - UPDATED with subtask description and member search
        function showCreateTaskModal() {
            // Reset selected members
            selectedMembers = [];
            updateSelectedMembersList();
            
            // Populate members checklist
            const checklist = document.getElementById('membersChecklist');
            checklist.innerHTML = teamMembers.map(member => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                    <input type="checkbox" id="member-${member.id}" value="${member.id}" class="member-checkbox" onchange="toggleMemberSelection(${member.id}, this.checked)">
                    <label for="member-${member.id}" style="flex: 1; cursor: pointer;">
                        <div style="font-weight: 500;">${member.name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${member.email}</div>
                    </label>
                </div>
            `).join('');
            
            showModal('createTaskModal');
        }

        function toggleAssignment() {
            const toggle = document.getElementById('assignmentToggle');
            const section = document.getElementById('assignmentSection');
            const assignSelects = document.querySelectorAll('.assignee-select');
            
            if (toggle.classList.contains('active')) {
                toggle.classList.remove('active');
                section.style.display = 'none';
                assignSelects.forEach(select => select.style.display = 'none');
            } else {
                toggle.classList.add('active');
                section.style.display = 'block';
                assignSelects.forEach(select => select.style.display = 'block');
                
                // Populate assignee dropdowns with selected members only
                updateAssigneeDropdowns();
            }
        }

        function filterMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const checkboxes = document.querySelectorAll('.member-checkbox');
            
            checkboxes.forEach(checkbox => {
                const memberId = checkbox.value;
                const member = teamMembers.find(m => m.id == memberId);
                const memberItem = checkbox.closest('div');
                
                if (member && (
                    member.name.toLowerCase().includes(searchTerm) || 
                    member.email.toLowerCase().includes(searchTerm)
                )) {
                    memberItem.style.display = 'flex';
                } else {
                    memberItem.style.display = 'none';
                }
            });
        }

        function toggleMemberSelection(memberId, isSelected) {
            const member = teamMembers.find(m => m.id == memberId);
            
            if (isSelected) {
                if (!selectedMembers.some(m => m.id == memberId)) {
                    selectedMembers.push(member);
                }
            } else {
                selectedMembers = selectedMembers.filter(m => m.id != memberId);
            }
            
            updateSelectedMembersList();
            updateAssigneeDropdowns();
        }

        function updateSelectedMembersList() {
            const container = document.getElementById('selectedMembersList');
            
            if (selectedMembers.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No members selected</div>';
                return;
            }
            
            container.innerHTML = selectedMembers.map(member => `
                <div class="selected-member-item">
                    <div>
                        <div style="font-weight: 500;">${member.name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${member.email}</div>
                    </div>
                    <button type="button" class="remove-member-btn" onclick="removeSelectedMember(${member.id})">Remove</button>
                </div>
            `).join('');
        }

        function removeSelectedMember(memberId) {
            selectedMembers = selectedMembers.filter(m => m.id != memberId);
            
            // Uncheck the checkbox
            const checkbox = document.getElementById(`member-${memberId}`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateSelectedMembersList();
            updateAssigneeDropdowns();
        }

        function updateAssigneeDropdowns() {
            const assignSelects = document.querySelectorAll('.assignee-select');
            
            assignSelects.forEach(select => {
                select.innerHTML = '<option value="">Select member...</option>' +
                    selectedMembers.map(member => 
                        `<option value="${member.id}">${member.name} - ${member.email}</option>`
                    ).join('');
            });
        }

        function addSubtaskField() {
            const container = document.getElementById('subtasksContainer');
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'subtask-item';
            
            const isAssignmentActive = document.getElementById('assignmentToggle').classList.contains('active');
            
            subtaskDiv.innerHTML = `
                <input type="text" class="subtask-input" placeholder="Subtask title" required>
                <textarea class="subtask-desc" placeholder="Subtask description (Optional)"></textarea>
                <select class="form-select assignee-select" style="display: ${isAssignmentActive ? 'block' : 'none'};">
                    <option value="">Select member...</option>
                    ${selectedMembers.map(member => 
                        `<option value="${member.id}">${member.name} - ${member.email}</option>`
                    ).join('')}
                </select>
                <button type="button" class="remove-subtask" onclick="removeSubtask(this)">Remove</button>
            `;
            container.appendChild(subtaskDiv);
        }

        function removeSubtask(button) {
            if (document.querySelectorAll('.subtask-item').length > 1) {
                button.parentElement.remove();
            } else {
                showMessage('At least one subtask is required', 'error');
            }
        }

        // Form submission
        document.getElementById('createTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createTask();
        });

        async function createTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assignSpecific = document.getElementById('assignmentToggle').classList.contains('active');
            
            // Collect subtasks - UPDATED to include description
            const subtaskItems = document.querySelectorAll('.subtask-item');
            const subtasks = Array.from(subtaskItems).map(item => {
                const title = item.querySelector('.subtask-input').value;
                const description = item.querySelector('.subtask-desc').value;
                const assigneeSelect = item.querySelector('.assignee-select');
                const assignedTo = assignSpecific && assigneeSelect ? assigneeSelect.value : null;
                
                return {
                    title: title,
                    description: description,
                    assigned_to: assignedTo || null
                };
            });

            if (subtasks.length === 0) {
                showMessage('Please add at least one subtask', 'error');
                return;
            }

            const taskData = {
                title,
                description,
                teamCode: currentUser.team_code,
                createdBy: currentUser.id,
                subtasks,
                assignSpecific
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Task created successfully!');
                    closeModal('createTaskModal');
                    document.getElementById('createTaskForm').reset();
                    // Reset to one subtask
                    document.getElementById('subtasksContainer').innerHTML = `
                        <div class="subtask-item">
                            <input type="text" class="subtask-input" placeholder="Subtask title" required>
                            <textarea class="subtask-desc" placeholder="Subtask description (Optional)"></textarea>
                            <select class="form-select assignee-select" style="display: none;">
                                <option value="">Select member...</option>
                            </select>
                            <button type="button" class="remove-subtask" onclick="removeSubtask(this)">Remove</button>
                        </div>
                    `;
                    // Reset assignment toggle
                    document.getElementById('assignmentToggle').classList.remove('active');
                    document.getElementById('assignmentSection').style.display = 'none';
                    // Reset selected members
                    selectedMembers = [];
                    updateSelectedMembersList();
                    
                    // Reload tasks to get the new task with its ID
                    await loadTasks();
                    // Update all displays
                    updateTaskDisplays();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('Failed to create task', 'error');
            }
        }

        // NEW FEATURES: Task Detail View
        async function showTaskDetail(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch task details');
                }
                const task = await response.json();
                
                // Populate task details
                document.getElementById('detailTaskTitle').textContent = task.title;
                document.getElementById('detailTaskDescription').textContent = task.description || 'No description provided';
                
                // Set status badge
                const statusBadge = document.getElementById('detailTaskStatus');
                statusBadge.textContent = getTaskStatusText(task);
                statusBadge.className = `status-badge ${getTaskStatusClass(task)}`;
                
                // Set metadata
                document.getElementById('detailCreatedBy').textContent = task.created_by_name || 'Unknown';
                document.getElementById('detailCreatedAt').textContent = new Date(task.created_at).toLocaleDateString();
                
                // Calculate completion date (last subtask completion)
                const completedSubtasks = task.subtasks.filter(st => st.status === 'completed');
                let completedDate = null;
                if (completedSubtasks.length > 0) {
                    // Find the latest completion date
                    completedDate = new Date(Math.max(...completedSubtasks.map(st => new Date(st.completed_at || st.updated_at))));
                    document.getElementById('detailCompletedAt').textContent = completedDate.toLocaleDateString();
                } else {
                    document.getElementById('detailCompletedAt').textContent = 'Not completed';
                }
                
                // Set progress
                const progress = calculateProgress(task);
                document.getElementById('detailProgress').textContent = `${progress}%`;
                
                // Populate subtasks
                const subtasksContainer = document.getElementById('detailSubtasksList');
                subtasksContainer.innerHTML = task.subtasks.map(subtask => {
                    const assignee = teamMembers.find(m => m.id === subtask.assigned_to);
                    const assigneeName = assignee ? assignee.name : 'Not assigned';
                    const completedDate = subtask.status === 'completed' && subtask.completed_at 
                        ? new Date(subtask.completed_at).toLocaleDateString() 
                        : 'Not completed';
                    
                    return `
                        <div class="detail-subtask-item">
                            <div class="detail-subtask-info">
                                <div class="detail-subtask-title">${subtask.title}</div>
                                <div class="detail-subtask-description" style="color: #666; margin-bottom: 5px;">${subtask.description || 'No description'}</div>
                                <div class="detail-subtask-assignee">
                                    <strong>Assigned to:</strong> ${assigneeName} | 
                                    <strong>Status:</strong> ${subtask.status} | 
                                    <strong>Completed:</strong> ${completedDate}
                                </div>
                            </div>
                            <span class="detail-subtask-status ${getSubtaskStatusClass(subtask)}">${subtask.status}</span>
                        </div>
                    `;
                }).join('');
                
                // Set up edit button
                document.getElementById('detailEditBtn').onclick = function() {
                    closeModal('taskDetailModal');
                    editTask(taskId);
                };
                
                showModal('taskDetailModal');
            } catch (error) {
                console.error('Error loading task details:', error);
                showMessage('Failed to load task details', 'error');
            }
        }

        function getSubtaskStatusClass(subtask) {
            switch(subtask.status) {
                case 'completed': return 'status-completed';
                case 'in-progress': return 'status-in-progress';
                case 'assigned': return 'status-assigned';
                case 'available': return 'status-available';
                default: return 'status-pending';
            }
        }

        // NEW PERFORMANCE TAB FUNCTIONS
        async function loadPerformanceData() {
            try {
                // Display loading messages
                document.getElementById('topPerformersGrid').innerHTML = '<p style="text-align: center; padding: 20px;">Loading top performers...</p>';
                document.getElementById('membersPerformanceTable').innerHTML = '<p style="text-align: center; padding: 20px;">Loading performance data...</p>';

                // Load performance data from API
                const response = await fetch(`${API_BASE}/performance/team/${currentUser.team_code}`);
                if (response.ok) {
                    memberPerformanceData = await response.json();
                    displayPerformanceData();
                } else {
                    console.error('Failed to load performance data');
                    memberPerformanceData = [];
                    displayPerformanceData();
                }
            } catch (error) {
                console.error('Error loading performance data:', error);
                showMessage('Failed to load performance data', 'error');
                memberPerformanceData = [];
                displayPerformanceData();
            }
        }

        function displayPerformanceData() {
            displayTopPerformers();
            displayMembersPerformanceTable();
        }

        function displayTopPerformers() {
            const container = document.getElementById('topPerformersGrid');
            
            if (memberPerformanceData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <h3>No Performance Data</h3>
                        <p>No team members have completed tasks yet</p>
                    </div>
                `;
                return;
            }

            // Sort members by completed tasks (descending) and take top 3
            const topPerformers = [...memberPerformanceData]
                .sort((a, b) => b.completed_tasks - a.completed_tasks)
                .slice(0, 3);

            if (topPerformers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üèÜ</div>
                        <h3>No Top Performers</h3>
                        <p>No team members have completed tasks yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = topPerformers.map((member, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze';
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                
                return `
                    <div class="top-performer-card ${rankClass}">
                        <div class="rank-badge ${rankClass}">${rankIcon}</div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: #333;">
                            ${member.name}
                        </div>
                        <div style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                            ${member.email}
                        </div>
                        <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;">${member.assigned_tasks || 0}</div>
                                <div style="font-size: 0.8rem; color: #666;">Assigned</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #28a745;">${member.completed_tasks || 0}</div>
                                <div style="font-size: 0.8rem; color: #666;">Completed</div>
                            </div>
                        </div>
                        <button class="view-details-btn" onclick="showMemberPerformanceDetails(${member.id})">
                            View Details
                        </button>
                    </div>
                `;
            }).join('');
        }

        function displayMembersPerformanceTable() {
            const container = document.getElementById('membersPerformanceTable');
            
            if (memberPerformanceData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>No Team Members</h3>
                        <p>No team members found with performance data</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="members-performance-table">
                    <table class="performance-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Tasks Assigned</th>
                                <th>Tasks Completed</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberPerformanceData.map(member => `
                                <tr>
                                    <td>
                                        <div class="member-info">
                                            <div class="member-avatar-small">${member.name.charAt(0).toUpperCase()}</div>
                                            <div class="member-details">
                                                <div class="member-name" onclick="showMemberPerformanceDetails(${member.id})" style="cursor: pointer;">
                                                    ${member.name}
                                                </div>
                                                <div class="member-email">${member.email}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="task-stats">
                                            <div class="stat-item">
                                                <div class="stat-value">${member.assigned_tasks || 0}</div>
                                                <div class="stat-label">Total</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="task-stats">
                                            <div class="stat-item">
                                                <div class="stat-value">${member.completed_tasks || 0}</div>
                                                <div class="stat-label">Completed</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="view-details-btn" onclick="showMemberPerformanceDetails(${member.id})">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function showMemberPerformanceDetails(memberId) {
            try {
                // Find member data
                const member = memberPerformanceData.find(m => m.id === memberId);
                if (!member) {
                    showMessage('Member not found', 'error');
                    return;
                }

                // Load member's completed tasks
                const tasksResponse = await fetch(`${API_BASE}/tasks/user/${memberId}/subtasks`);
                let completedTasks = [];
                if (tasksResponse.ok) {
                    const allTasks = await tasksResponse.json();
                    completedTasks = allTasks.filter(task => task.progress === 'completed');
                }

                // Populate modal content
                document.getElementById('memberPerformanceContent').innerHTML = `
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="member-avatar" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                ${member.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #333;">${member.name}</div>
                                <div style="color: #666;">${member.email}</div>
                            </div>
                        </div>

                        <div class="member-details-grid">
                            <div class="member-detail-card">
                                <div class="member-detail-value">${member.assigned_tasks || 0}</div>
                                <div class="member-detail-label">Total Tasks Assigned</div>
                            </div>
                            <div class="member-detail-card">
                                <div class="member-detail-value">${member.completed_tasks || 0}</div>
                                <div class="member-detail-label">Tasks Completed</div>
                            </div>
                            <div class="member-detail-card">
                                <div class="member-detail-value">${member.in_progress_tasks || 0}</div>
                                <div class="member-detail-label">In Progress</div>
                            </div>
                            <div class="member-detail-card">
                                <div class="member-detail-value">${member.completion_rate || 0}%</div>
                                <div class="member-detail-label">Completion Rate</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 15px; color: #333;">Completed Tasks</h3>
                        ${completedTasks.length > 0 ? `
                            <div class="completed-tasks-list">
                                ${completedTasks.map(task => `
                                    <div class="completed-task-item">
                                        <div class="completed-task-title">${task.task_title} - ${task.title}</div>
                                        <div class="completed-task-description" style="color: #666; margin: 5px 0;">${task.description || 'No description'}</div>
                                        <div class="completed-task-meta">
                                            Completed on: ${new Date(task.updated_at).toLocaleDateString()} | 
                                            Main Task: ${task.task_title}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state" style="padding: 30px;">
                                <div class="icon">üìù</div>
                                <h3>No Completed Tasks</h3>
                                <p>This member hasn't completed any tasks yet</p>
                            </div>
                        `}
                    </div>
                `;

                showModal('memberPerformanceModal');
            } catch (error) {
                console.error('Error loading member performance details:', error);
                showMessage('Failed to load member details', 'error');
            }
        }

        function filterPerformanceData() {
            const searchTerm = document.getElementById('performanceSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.performance-filters .performance-filter-btn.active').getAttribute('data-filter');
            
            let filteredData = [...memberPerformanceData];
            
            // Apply search filter by name or email
            if (searchTerm) {
                filteredData = filteredData.filter(member => 
                    member.name.toLowerCase().includes(searchTerm) ||
                    member.email.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply performance category filter
            if (activeFilter === 'top') {
                filteredData = filteredData.filter(member => 
                    (member.completion_rate >= 80 || member.completed_tasks > 5) && member.total_tasks > 0
                );
            } else if (activeFilter === 'low') {
                filteredData = filteredData.filter(member => 
                    member.completion_rate < 50 && member.total_tasks > 0
                );
            }
            
            // Update the table display
            const container = document.getElementById('membersPerformanceTable');
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <h3>No Members Found</h3>
                        <p>No members match your current filter criteria</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="members-performance-table">
                        <table class="performance-table">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Tasks Assigned</th>
                                    <th>Tasks Completed</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredData.map(member => `
                                    <tr>
                                        <td>
                                            <div class="member-info">
                                                <div class="member-avatar-small">${member.name.charAt(0).toUpperCase()}</div>
                                                <div class="member-details">
                                                    <div class="member-name" onclick="showMemberPerformanceDetails(${member.id})" style="cursor: pointer;">
                                                        ${member.name}
                                                    </div>
                                                    <div class="member-email">${member.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="task-stats">
                                                <div class="stat-item">
                                                    <div class="stat-value">${member.assigned_tasks || 0}</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="task-stats">
                                                <div class="stat-item">
                                                    <div class="stat-value">${member.completed_tasks || 0}</div>
                                                    <div class="stat-label">Completed</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="view-details-btn" onclick="showMemberPerformanceDetails(${member.id})">
                                                View Details
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
